    // ==UserScript==
    // @name         Youtube Enhancer
    // @namespace    http://tampermonkey.net/
    // @version      1.0
    // @description  try to take over the world!
    // @author       You
    // @match        https://www.youtube.com/*
    // @icon         https://www.google.com/s2/favicons?sz=64&domain=youtube.com
    // @grant        none
    // ==/UserScript==

    (function () {
        // Core Module: Shared state, utilities, and DOM cache
        const Core = (function () {
            let isClicked = true;
            let isSkippingEnabled = true;
            let hasNavigationButtonBeenFetched = false;
            let navigationButtonDown = null;
            let lastUrl = null;
            let lastShortsId = null;
            let observer = null;
            let observerShortsId = null;
            let isScrollButtonCreated = false;
            let lastProcessedShortsId = null;
            let lastMaxLoadTime = 500;
            let lastWheelEvent = 0;
            let lastKeyEvent = 0;
            const debounceDelay = 1000;
            const STYLE_TAG_ID = 'efyt-dynamic-styles';

            const cache = {
                center: null,
                container: null,
                primary: null,
                columns: null
            };

            function throttle(fn, delay) {
                let lastCall = 0;
                return (...args) => {
                    const now = Date.now();
                    if (now - lastCall >= delay) {
                        lastCall = now;
                        fn(...args);
                    }
                };
            }

            function debounce(fn, delay) {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        fn(...args);
                    }, delay);
                };
            }

            function waitForDOMElement(selector, callback, options = {}) {
                const { interval = 100, timeout = 15000, delay = 0 } = options;
                const startTime = Date.now();
                const checkElement = () => {
                    const element = document.querySelector(selector);
                    if (element) {
                        callback(element);
                    } else if (Date.now() - startTime < timeout) {
                        setTimeout(checkElement, interval);
                    }
                };
                if (delay > 0) {
                    setTimeout(checkElement, delay);
                } else {
                    checkElement();
                }
            }

            function waitForAllDOMElements(selectors, options = {}) {
                const { timeout = 15000, maxRetries = 2, defaultDelay = 100 } = options;
                return new Promise((resolve, reject) => {
                    const results = {};
                    let completed = 0;
                    let retryCount = 0;

                    function pollElements(remainingSelectors) {
                        if (!remainingSelectors.length) {
                            resolve(results);
                            return;
                        }

                        remainingSelectors.forEach(selector => {
                            if (results[selector]) return; // Skip already found
                            waitForDOMElement(
                                selector,
                                element => {
                                    results[selector] = { element, foundAt: performance.now() };
                                    completed++;
                                    if (completed === selectors.length) {
                                        // Update lastMaxLoadTime based on max load time
                                        const loadTimes = Object.values(results).map(r => r.foundAt - performance.now());
                                        Core.state.lastMaxLoadTime = Math.max(...loadTimes, defaultDelay);
                                        resolve(results);
                                    }
                                },
                                { interval: 100, timeout, delay: Core.state.lastMaxLoadTime || defaultDelay }
                            );
                        });

                        setTimeout(() => {
                            if (completed < selectors.length && retryCount < maxRetries) {
                                retryCount++;
                                // Calculate dynamic retry delay based on found elements
                                const foundTimes = Object.values(results).map(r => r.foundAt - performance.now());
                                const avgLoadTime = foundTimes.length ? foundTimes.reduce((a, b) => a + b, 0) / foundTimes.length : timeout / 2;
                                const retryDelay = Math.max(1000, avgLoadTime * 1.5);
                                console.warn(`Retrying ${remainingSelectors.filter(s => !results[s]).length} selectors, attempt ${retryCount + 1}/${maxRetries}, delay ${retryDelay}ms`);
                                setTimeout(() => pollElements(remainingSelectors.filter(s => !results[s])), retryDelay);
                            } else if (completed < selectors.length) {
                                const missing = selectors.filter(s => !results[s]);
                                reject(new Error(`Failed to find selectors after ${maxRetries} retries: ${missing.join(', ')}`));
                            }
                        }, timeout);
                    }
                    pollElements(selectors);
                });
            }

            function checkIfWatchPage() {
                return window.location.href.includes('youtube.com/watch');
            }

            function checkIfShortsPage() {
                return window.location.href.includes('youtube.com/shorts');
            }

            function getShortsId() {
                const url = window.location.href;
                const match = url.match(/youtube\.com\/shorts\/([^?]+)/);
                return match ? match[1] : null;
            }

            function pauseVideo() {
                const videoElement = document.querySelector('video');
                if (videoElement && !videoElement.paused) {
                    videoElement.pause();
                }
            }

            function safeInjectCSS(css, id) {
                // Remove previous version if exists
                const existing = document.querySelector(`style[data-injected-css="${id}"]`);
                if (existing) existing.remove();

                // Inject fresh
                const style = document.createElement('style');
                style.setAttribute('data-injected-css', id);
                style.textContent = css.trim();
                document.head.appendChild(style);
            };

            function removeCSS(id) {
                const el = document.querySelector(`style[style-comment="${id}"]`);
                if (el) el.remove();
            }


            return {
                state: {
                    isClicked, isSkippingEnabled, hasNavigationButtonBeenFetched, navigationButtonDown,
                    lastUrl, lastShortsId, observer, observerShortsId, isScrollButtonCreated,
                    lastProcessedShortsId, lastMaxLoadTime, lastWheelEvent, lastKeyEvent, debounceDelay, STYLE_TAG_ID
                },
                utils: { throttle, debounce, safeInjectCSS, removeCSS, waitForDOMElement, waitForAllDOMElements, checkIfWatchPage, checkIfShortsPage, getShortsId, pauseVideo },
                cache
            };
        })();

        // Styles Module: CSS injection
        const Styles = (function () {
            const styleElement = document.createElement('style');
            document.head.appendChild(styleElement);
            // Update the stylesheet
            styleElement.textContent = `
                :root {
                    --dark-bt: rgb(200 200 200 / 15%);
                    --dark-bt-hover: rgba(255 255 255 /25%);
                    --dark-bt-tp: rgb(0 0 0 / 1%);
                    --light-bt: rgb(0 0 0 / 7%);
                    --light-bt-tp: rgb(255 255 255 / 1%);
                    --light-bt-hover: rgb(0 0 0 / 15%);
                    --efyt-mini-player-aspect-ratio: 1.8;
                    --efyt-mini-player-height: 315px;
                    --efyt-mini-player-width: 560px;
                    --efyt-mini-player-center-left: calc(100vw / 2 - 280px);
                    --efyt-mini-player-caption-window-left: calc(var(--efyt-mini-player-width) * 1 / 10);
                    --efyt-mini-player-caption-window-width: calc(var(--efyt-mini-player-width) * 8 / 10);
                    --efyt-mini-player-short-width: calc(var(--efyt-mini-player-height) * var(--efyt-mini-player-aspect-ratio));
                    --efyt-mini-player-short-left: calc(calc(var(--efyt-mini-player-width) - calc(var(--efyt-mini-player-height) * var(--efyt-mini-player-aspect-ratio))) / 2);
                }
                #start.ytd-masthead, #end.ytd-masthead {
                    height: 50px;
                    border-radius: 30px;
                    display: flex;
                    position: static;
                    margin: 0 10%;
                    border: 1px dotted red;
                    background-color: var(--light-bt);
                }
                .ytSearchboxComponentHost {
                    height: 53px;
                    margin: 0 12px 0 0;
                }
                .ytSearchboxComponentInputBox {
                    margin: 0 0 0 0;
                    border: 1px dotted red;
                    box-shadow: none;
                    height: 50px;
                    background: transparent;
                    background-color: var(--light-bt);
                    display: flex;
                    justify-content: space-around;
                }
                #center.ytd-masthead {
                    margin: auto;
                    flex: 0 0 550px;
                }
                .ytp-delhi-modern.ytp-big-mode:not(.ytp-xsmall-width-mode) .ytp-chrome-bottom {
                    height: 80px !important;
                }
                .ytp-big-mode .ytp-progress-bar-container {
                    bottom: 65.5px !important;
                }
                ytd-rich-grid-renderer {
                    --ytd-rich-grid-items-per-row: 4 !important;
                }
                #container.ytd-masthead {
                    box-shadow: none;
                    background: transparent;
                    display: flex;
                    opacity: 1;
                    z-index: 1000;
                    justify-content: space-evenly;
                }
                #contents.ytd-rich-grid-renderer {
                    padding-top: 65px;
                }
                ytd-watch-flexy[flexy] #secondary.ytd-watch-flexy {
                    min-width: 450px;
                    padding-right: 0px;
                }
                .ytSearchboxComponentSearchButton {
                    background: transparent;
                    border: 1px dotted red;
                    background-color: var(--light-bt) !important;
                    height: 52px;
                }
                #background.ytd-masthead {
                    position: fixed;
                    opacity: 0;
                    visibility: visible;
                    background: transparent;
                    height: 56px;
                    z-index -1;
                }
                #search-form.ytd-searchbox {
                    height: 50px;
                }
                ytd-searchbox.ytd-masthead {
                    margin: 0;
                    padding: 0 10px;
                }
                #sections.ytd-guide-renderer {
                    position: relative;
                }
                #sections.ytd-guide-renderer>*.ytd-guide-renderer:first-child {
                    padding: 0px;
                }
                #voice-search-button.ytd-masthead {
                    margin-left: 0;
                    background: transparent;
                    background-color: var(--light-bt) !important;
                }
                #chips-wrapper.ytd-feed-filter-chip-bar-renderer {
                    opacity: 0.6;
                }
                .ytSpecIconShapeHost {
                    color: #c00;
                }
                ytd-feed-filter-chip-bar-renderer {
                    height: 0;
                }
                #frosted-glass.with-chipbar.ytd-app {
                    height: 112px !important;
                    backdrop-filter: blur(2px) !important;
                }
                .yt-core-attributed-string--white-space-no-wrap {
                    color: #c00;
                }
                .yt-spec-button-shape-next--mono.yt-spec-button-shape-next--filled {
                    background: none;
                    color:black;
                }
                yt-chip-cloud-chip-renderer[chip-style=STYLE_DEFAULT][selected] #chip-container.yt-chip-cloud-chip-renderer {
                    background-color: var(--yt-spec-badge-chip-background);
                    color: var(--yt-spec-text-primary);
                }
                .yt-spec-touch-feedback-shape:where([class="yt-spec-touch-feedback-shape yt-spec-touch-feedback-shape--touch-response"]) {
                    border: 1px dotted red;
                }
                body.efyt-mini-player.efyt-short #movie_player:not(.ytp-fullscreen) video.html5-main-video,
                body.efyt-wide-player.efyt-mini-player.efyt-short ytd-watch-flexy[theater] #movie_player:not(.ytp-fullscreen) video.html5-main-video {
                    left: var(--efyt-mini-player-short-left);
                    aspect-ratio: auto;
                    object-fit: contain;
                }
                body.efyt-mini-player #movie_player:not(.ytp-fullscreen) .ytp-caption-window-container > div.caption-window {
                    left: var(--efyt-mini-player-caption-window-left);
                }
                .ytp-delhi-modern.ytp-delhi-modern-compact-controls .ytp-chrome-controls .ytp-play-button svg {
                    width: 24px;
                    height: 24px;
                    padding: 12px !important;
                }
                body.efyt-mini-player.efyt-short #movie_player:not(.ytp-fullscreen) {
                    height: var(--efyt-mini-player-height);
                    aspect-ratio: auto;
                }

                body.efyt-mini-player ytd-player #movie_player:not(.ytp-fullscreen) {
                    position: fixed !important;
                    z-index: 5000 !important;
                    background: rgb(0, 0, 0) !important;
                }
                @media (prefers-color-scheme: dark) {
                    #start.ytd-masthead,
                    .ytSearchboxComponentInputBox,
                    #container.ytd-searchbox,
                    #end.ytd-masthead,
                    .scroll-top-btn,
                    .skip-toggle-btn,
                    .ytSearchboxComponentSearchButton,
                    .yt-spec-touch-feedback-shape:where([class="yt-spec-touch-feedback-shape yt-spec-touch-feedback-shape--touch-response"]),
                    #voice-search-button.ytd-masthead
                    {
                        background-color: var(--dark-bt) !important;
                    }
                    #content > yt-lockup-view-model > div > yt-touch-feedback-shape > div {
                        background-color: var(--dark-bt-tp);
                    }
                    .yt-spec-button-shape-next--mono.yt-spec-button-shape-next--filled {
                        color: red;
                    }
                    #start.ytd-masthead:hover,
                    .ytSearchboxComponentInputBox:hover,
                    #container.ytd-searchbox:hover,
                    #end.ytd-masthead:hover,
                    .scroll-top-btn:hover,
                    .skip-toggle-btn:hover,
                    .ytSearchboxComponentSearchButton:hover,
                    .yt-spec-button-shape-next--overlay.yt-spec-button-shape-next--text:hover,
                    #voice-search-button.ytd-masthead:hover
                    {
                        background-color: var(--dark-bt-hover) !important;
                    }
                }
                #scroll-top-container {
                    position: fixed;
                    bottom: 20px;
                    width: 55px;
                    height: 55px;
                    transition: opacity 0.3s ease;
                    z-index: 1000;
                    opacity: 0;
                }
                .scroll-top-btn {
                    pointer-events: all;
                    width: 100%;
                    height: 100%;
                    border-radius: 50%;
                    cursor: pointer;
                    border: 1px dotted red;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    background-color: var(--light-bt);
                }
                .scroll-top-btn:hover {
                    background-color: var(--light-bt-hover);
                }
                .scroll-up-btn {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100%;
                    width: 100%;
                }
                .skip-toggle-btn {
                    pointer-events: all;
                    width: 56px;
                    height: 56px;
                    margin: 0;
                    border-radius: 50%;
                    cursor: pointer;
                    border: none;
                    transition: background-color 0.2s ease, opacity 4s ease;
                    opacity: 1;
                    justify-self: center;
                    align-items: center;
                }
                .skip-toggle-btn:hover {
                    background-color: var(--light-bt-hover) !important;
                }
                .toggle-icon {
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100%;
                    width: 100%;
                    color: #c00;
                    font-size: 13px;
                    font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande',
                    'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
                    font-weight: 600;
                }
                .skip-tooltip {
                    display: flex;
                    position: absolute;
                    left: -150px;
                    top: 0;
                    height: 25px;
                    transform: translateY(8px);
                    background-color: #707070;
                    color: #ffffff;
                    padding: 6px 8px;
                    border-radius: 4px;
                    font-family: "Roboto", "Arial", sans-serif;
                    font-size: 1.2rem;
                    line-height: 1.8rem;
                    font-weight: 400;
                    align-items: center;
                    z-index: 1001;
                    opacity: 0;
                    visibility: hidden;
                    transition: opacity 0.2s ease-in-out;
                }
                .skip-toggle-btn:hover+.skip-tooltip,
                .skip-tooltip:hover {
                    opacity: 1;
                    visibility: visible;
                }
            `;
        })();

        // Layout Module: Layout updates with cached DOM elements via waitForAllDOMElements
        const Layout = (function () {
            const { utils, cache } = Core;

            function updateLayout() {
                // Check if masthead elements are cached
                if (!cache.center || !cache.center.isConnected || !cache.container || !cache.container.isConnected) {
                    const selectors = ['#center.ytd-masthead', '#container.ytd-masthead'];
                    utils.waitForAllDOMElements(selectors, { timeout: 15000, maxRetries: 2 })
                        .then(results => {
                            cache.center = results['#center.ytd-masthead'].element;
                            cache.container = results['#container.ytd-masthead'].element;
                            if (cache.center && cache.container) {
                                const windowWidth = window.innerWidth;
                                const scrollPosition = window.scrollY || document.documentElement.scrollTop;
                                cache.container.style.opacity = scrollPosition === 0 ? '1' : '0.6';
                                let centerFlexBasis = 200 + (windowWidth - 1035) * 0.3955;
                                centerFlexBasis = Math.max(200, Math.min(550, centerFlexBasis));
                                cache.center.style.flex = `0 0 ${centerFlexBasis}px`;
                            }
                        })
                        .catch(() => { });
                } else {
                    // Use cached masthead elements
                    const windowWidth = window.innerWidth;
                    const scrollPosition = window.scrollY || document.documentElement.scrollTop;
                    cache.container.style.opacity = scrollPosition === 0 ? '1' : '0.6';
                    let centerFlexBasis = 200 + (windowWidth - 1035) * 0.3955;
                    centerFlexBasis = Math.max(200, Math.min(550, centerFlexBasis));
                    cache.center.style.flex = `0 0 ${centerFlexBasis}px`;
                }

                if (utils.checkIfWatchPage()) {
                    // Cache primary and columns if not already cached
                    if (!cache.primary || !cache.primary.isConnected || !cache.columns || !cache.columns.isConnected) {
                        const selectors = ['#primary', '#columns'];
                        utils.waitForAllDOMElements(selectors, { timeout: 15000, maxRetries: 2 })
                            .then(results => {
                                cache.primary = results['#primary'].element;
                                cache.columns = results['#columns'].element;
                                applyWatchStyles();
                            })
                            .catch(err => console.error(`Watch page caching failed: ${err.message}`));
                    } else {
                        applyWatchStyles();
                    }
                }

                function applyWatchStyles() {
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    const TOP_BAR_HEIGHT_PX = 56;
                    const topBarHeightVh = (TOP_BAR_HEIGHT_PX / viewportHeight) * 100;
                    const availableHeightVh = 100 - topBarHeightVh;
                    const maxHeightFromAspectRatioVh = (viewportWidth / viewportHeight) * (9 / 16) * 100;
                    const finalMaxHeightVh = Math.min(availableHeightVh, maxHeightFromAspectRatioVh);
                    const height = finalMaxHeightVh.toFixed(4);

                    let maxWidthValuePrim, maxWidthValueCol, position;
                    if ((window.screen.width >= 2560 && window.screen.width <= 3840) && (window.screen.height >= 1440 && window.screen.height <= 2160)) {
                        maxWidthValueCol = 3600;
                        maxWidthValuePrim = 3300;
                    } else {
                        maxWidthValueCol = 2065;
                        maxWidthValuePrim = 1850;
                    }

                    const css = `
                        #primary.ytd-watch-flexy {
                            max-width: ${maxWidthValuePrim}px !important;
                            margin-left: 10px !important;
                            margin-top: 12px !important;
                        }
                        #columns.ytd-watch-flexy {
                            max-width: ${maxWidthValueCol}px !important;
                        }
                        ytd-watch-flexy[full-bleed-player][respect-aspect-ratio]:not([fullscreen]) #full-bleed-container.ytd-watch-flexy,
                        ytd-watch-flexy[full-bleed-player] #full-bleed-container.ytd-watch-flexy {
                            z-index: 1200 !important;
                            height: ${height}vh !important;
                            max-height: ${height}vh !important;
                        }
                        .html5-video-player .video-stream {
                            top: 2px !important;
                            height: ${height}vh;
                            max-height: ${height}vh !important;
                            object-fit: contain !important;
                        }
                        .ytp-delhi-modern .ytp-heat-map-container {
                            left: 5px !important;
                        }
                        .ytp-progress-bar {
                            left: 5px !important;
                        }
                        ytd-watch-flexy[full-bleed-player] #player-container.ytd-watch-flexy,
                        ytd-watch-flexy[full-bleed-player] #player.ytd-watch-flexy {
                            max-height: ${height}vh !important;
                        }
                    `;
                    let pageStyles = document.querySelector('style[data-page-styles]');
                    if (!pageStyles) {
                        pageStyles = document.createElement('style');
                        pageStyles.setAttribute('data-page-styles', 'true');
                        document.head.appendChild(pageStyles);
                    }
                    pageStyles.textContent = css;
                }
            }

            return { updateLayout };
        })();

        // Shorts Module: Shorts skipping and toggle button
        const Shorts = (function () {
            const { state, utils } = Core;

            function createShortsSkipBtn() {
                if (utils.checkIfShortsPage()) {
                    let autoskipContainer = document.getElementById('shorts-autoskip');
                    if (!autoskipContainer) {
                        autoskipContainer = document.createElement('div');
                        autoskipContainer.className = 'navigation-button style-scope ytd-shorts';
                        autoskipContainer.id = 'shorts-autoskip';

                        const toggleButton = document.createElement('button');
                        toggleButton.id = 'shorts-skip-toggle';
                        toggleButton.className = 'skip-toggle-btn';

                        const touchFeedbackShape = document.createElement('div');
                        touchFeedbackShape.className = 'yt-spec-touch-feedback-shape yt-spec-touch-feedback-shape--touch-response';
                        toggleButton.appendChild(touchFeedbackShape);

                        const icon = document.createElement('span');
                        icon.className = 'toggle-icon';
                        icon.textContent = 'SKIP';
                        toggleButton.appendChild(icon);

                        const tooltip = document.createElement('div');
                        tooltip.className = 'skip-tooltip';
                        tooltip.textContent = 'Toggle Video Skipping';
                        tooltip.setAttribute('role', 'tooltip');
                        tooltip.setAttribute('aria-label', 'Toggle Video Skipping');

                        autoskipContainer.appendChild(toggleButton);
                        autoskipContainer.appendChild(tooltip);

                        utils.waitForDOMElement(
                            '.navigation-container.style-scope.ytd-shorts',
                            navigationContainer => {
                                utils.waitForDOMElement(
                                    '#navigation-button-up',
                                    navigationButtonUp => {
                                        navigationContainer.insertBefore(autoskipContainer, navigationButtonUp);
                                    },
                                    { interval: 100, timeout: 15000 }
                                );
                            },
                            { interval: 100, timeout: 15000 }
                        );

                        toggleButton.addEventListener('click', () => {
                            state.isSkippingEnabled = !state.isSkippingEnabled;
                            icon.textContent = state.isSkippingEnabled ? 'SKIP' : 'NO SKIP';

                            if (state.isSkippingEnabled) {
                                const progressBarElement = document.querySelector('#scrubber > desktop-shorts-player-controls > div > yt-progress-bar > div');
                                if (progressBarElement && state.observer) {
                                    state.observer.observe(progressBarElement, {
                                        attributes: true,
                                        attributeFilter: ['aria-valuetext'],
                                    });
                                }
                            } else if (!state.isSkippingEnabled && state.observer) {
                                state.observer.disconnect();
                            }
                        });
                    }
                }
            }

            function SkippingShortsMechanism() {
                if (utils.checkIfShortsPage()) {
                    const currentShortsId = utils.getShortsId();
                    if (currentShortsId === state.lastProcessedShortsId && state.observer && currentShortsId === state.observerShortsId) {
                        // Verify if observer is capturing progress bar
                        const progressBarElement = document.querySelector('#scrubber > desktop-shorts-player-controls > div > yt-progress-bar > div');
                        if (progressBarElement && state.observer) {
                            const ariaValueText = progressBarElement.getAttribute('aria-valuetext');
                            if (!ariaValueText || parseFloat(ariaValueText.replace('%', '')) === 0) {
                                // Progress bar not updating, force reinitialization
                                state.observer.disconnect();
                                state.observer = null;
                                state.observerShortsId = null;
                            } else {
                                return; // Observer is working, no need to reinitialize
                            }
                        }
                    }
                    state.isClicked = false;
                    state.lastProcessedShortsId = currentShortsId;

                    // Disconnect existing observer immediately
                    if (state.observer) {
                        state.observer.disconnect();
                        state.observer = null;
                        state.observerShortsId = null;
                    }

                    const selectors = [
                        '#navigation-button-down > ytd-button-renderer > yt-button-shape > button',
                        '#scrubber > desktop-shorts-player-controls > div > yt-progress-bar > div'
                    ];

                    // Function to initialize observer for the progress bar
                    function initializeObserver(progressBarElement, navButton) {
                        let maxWidth = 0;
                        let previousWidth = 0;
                        let mutationCount = 0;
                        let lastMutationTime = Date.now();

                        state.observer = new MutationObserver(mutations => {
                            mutationCount++;
                            lastMutationTime = Date.now();
                            mutations.forEach(mutation => {
                                if (mutation.attributeName === 'aria-valuetext' && state.isSkippingEnabled) {
                                    // Revalidate progress bar element
                                    let currentProgressBar = document.querySelector('#scrubber > desktop-shorts-player-controls > div > yt-progress-bar > div');
                                    if (!currentProgressBar || currentProgressBar !== progressBarElement) {
                                        // Progress bar is stale, reinitialize
                                        state.observer.disconnect();
                                        state.observer = null;
                                        state.observerShortsId = null;
                                        attemptObserverSetup(navButton);
                                        return;
                                    }

                                    let ariaValueText = progressBarElement.getAttribute('aria-valuetext');
                                    if (ariaValueText) {
                                        let widthNumber = parseFloat(ariaValueText.replace('%', ''));
                                        if (widthNumber >= maxWidth) {
                                            maxWidth = widthNumber;
                                            previousWidth = widthNumber;
                                        } else if (!state.isClicked) {
                                            if ((widthNumber === 0 || widthNumber === 1) && previousWidth >= 97) {
                                                utils.pauseVideo();
                                                state.navigationButtonDown.click();
                                                state.isClicked = true;
                                                state.observer.disconnect();
                                                state.observer = null;
                                                state.observerShortsId = null;
                                                maxWidth = 0;
                                                previousWidth = 0;
                                            } else {
                                                previousWidth = widthNumber;
                                            }
                                        }
                                    }
                                }
                            });
                        });

                        state.observer.observe(progressBarElement, {
                            attributes: true,
                            attributeFilter: ['aria-valuetext'],
                        });
                        state.observerShortsId = currentShortsId;

                        // Monitor if observer is capturing updates
                        setTimeout(() => {
                            if (Date.now() - lastMutationTime > 2000 && state.observer && state.observerShortsId === currentShortsId) {
                                console.warn("Observer not capturing progress bar, reinitializing...");
                                state.observer.disconnect();
                                state.observer = null;
                                state.observerShortsId = null;
                                attemptObserverSetup(navButton);
                            }
                        }, 2500); // Check after 2.5s
                    }

                    // Function to attempt observer setup with polling
                    function attemptObserverSetup(navButton) {
                        const progressBarSelector = '#scrubber > desktop-shorts-player-controls > div > yt-progress-bar > div';
                        utils.waitForDOMElement(
                            progressBarSelector,
                            progressBarElement => {
                                if (progressBarElement) {
                                    initializeObserver(progressBarElement, navButton);
                                }
                            },
                            { interval: 50, timeout: 5000 } // Fast polling, 5s timeout
                        ).catch(err => {
                            console.error(`Failed to find progress bar: ${err.message}`);
                            // Retry once after a delay if initial attempt fails
                            setTimeout(() => {
                                utils.waitForDOMElement(
                                    progressBarSelector,
                                    progressBarElement => {
                                        if (progressBarElement) {
                                            initializeObserver(progressBarElement, navButton);
                                        }
                                    },
                                    { interval: 50, timeout: 3000 }
                                ).catch(err => console.error(`Retry failed: ${err.message}`));
                            }, 1000);
                        });
                    }

                    utils.waitForAllDOMElements(selectors, { timeout: 10000, maxRetries: 3 })
                        .then(results => {
                            const navButton = results[selectors[0]].element;
                            const progressBarElement = results[selectors[1]].element;

                            if (!state.hasNavigationButtonBeenFetched) {
                                state.navigationButtonDown = navButton;
                                state.hasNavigationButtonBeenFetched = true;

                                state.navigationButtonDown.addEventListener('click', function observerReinitHandler(e) {
                                    if (!e.isTrusted) return;
                                    state.navigationButtonDown.removeEventListener('click', observerReinitHandler);
                                    if (state.observer) {
                                        state.observer.disconnect();
                                        state.observer = null;
                                        state.observerShortsId = null;
                                    }
                                    attemptObserverSetup(navButton);
                                });
                            }

                            attemptObserverSetup(navButton);
                        })
                        .catch(err => console.error(`waitForAllDOMElements failed: ${err.message}`));
                }
            }
            function handleKeyEvent(event) {
                if (!utils.checkIfShortsPage()) return;
                const now = Date.now();
                // Handle both keydown (38, 40) and keyup (38, 40) for Up/Down keys
                if ((event.keyCode === 38 || event.keyCode === 40) && now - state.lastKeyEvent > state.debounceDelay) {
                    state.lastKeyEvent = now;
                    if (utils.checkIfShortsPage()) {
                        const currentShortsId = utils.getShortsId();
                        if (currentShortsId !== state.observerShortsId) {
                            if (state.observer) {
                                state.observer.disconnect();
                                state.observer = null;
                                state.observerShortsId = null;
                            }
                            state.lastShortsId = currentShortsId;
                        }
                    }
                }
            }
            function removeToggleButton() {
                const toggleButton = document.querySelector('#shorts-skip-toggle');
                if (toggleButton && toggleButton.parentNode) {
                    toggleButton.dispatchEvent(new Event('remove'));
                    toggleButton.parentNode.removeChild(toggleButton);
                }
            }

            return { createShortsSkipBtn, SkippingShortsMechanism, removeToggleButton, handleKeyEvent };
        })();

        // Watch Module: Scroll-to-top button
        const Watch = (function () {
            const { state: wsState, utils } = Core;
            wsState.isMiniPlayerActive = false;
            wsState.isScrollButtonCreated = false;


            let wasAbove1000 = false; // tracks scroll zone to avoid unnecessary calls
            function resetMiniPlayerCompletely() {
                const player = document.querySelector("#movie_player");
                const video = document.querySelector("video.html5-main-video");
                const chromeBottom = document.querySelector(".ytp-chrome-bottom");
                const progressContainer = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-heat-map-container");
                const progressBar = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-progress-bar");
                const chaptercontainer = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-progress-bar > div.ytp-chapters-container > div");

                if (player) {
                    // Remove all inline styles we set

                    player.classList.remove(
                        'ytp-delhi-modern-compact-controls',
                        'ytp-rounded-miniplayer-not-regular-wide-video',
                        'playing-mode'
                    );
                }

                if (video) video.style.cssText = "";
                if (player) player.style.cssText = "";
                if (chromeBottom) chromeBottom.style.cssText = "";
                if (progressContainer) progressContainer.style.cssText = "";
                if (progressBar) progressBar.style.cssText = "";
                //if (chaptercontainer) chaptercontainer.style.cssText = "";

                document.body.classList.remove('efyt-mini-player');

                wasAbove1000 = false;
            }

            function activateMiniPlayer() {
                const viewportWidth = window.innerWidth;
                let position;
                const player = document.querySelector("#movie_player");
                const video = document.querySelector("video.html5-main-video");
                const chromeBottom = document.querySelector(".ytp-chrome-bottom");
                const progressContainer = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-heat-map-container");
                const progressBar = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-progress-bar");
                const chaptercontainer = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-progress-bar > div.ytp-chapters-container > div");


                // Your existing position logic
                if ((window.screen.width >= 2560 && window.screen.width <= 3840) &&
                    (window.screen.height >= 1440 && window.screen.height <= 2160)) {
                    position = Math.max(900, Math.min(2660, 0.769 * (viewportWidth - 900) + 900));
                } else {
                    position = Math.max(410, Math.min(1300, 0.8633 * (viewportWidth - 985) + 100));
                }

                // === 1. Player container (#movie_player) ===
                Object.assign(player.style, {
                    width: "560px",
                    height: "315px",
                    left: `${position}px`,
                    top: "55px",
                    borderRadius: "14px",
                });

                // === 2. Video element itself ===
               if (video) {
                Object.assign(video.style, {
                    width: "560px",
                    height: "315px",
                    left: "0px",
                    borderRadius: "15px",
                });
                }

                // === 3. Bottom controls bar (ytp-chrome-bottom) ===
                if (chromeBottom) {
                    Object.assign(chromeBottom.style, {
                        left: "10px",
                        width: "98%",
                        maxWidth: "530px",
                    });
                }

                if(chaptercontainer){
                    Object.assign(chaptercontainer.style, {
                        width: "99%",
                    });
                }
                if(progressBar){
                    Object.assign(progressBar.style, {
                        width: "530px",
                    });
                }

                // === 4. Progress bar container (thicker + correct position) ===
                Object.assign(progressContainer.style, {
                    zIndex: "60",
                    bottom: "0",
                    height: "60px",
                });

                // === 6. Force compact controls + rounded look ===
                player.classList.add(
                    'ytp-delhi-modern-compact-controls',
                    'ytp-rounded-miniplayer-not-regular-wide-video',
                    'playing-mode'
                );

                // === 7. Force compact CSS variables (critical for pill size) ===
                Object.assign(player.style, {
                    '--yt-delhi-pill-height': '40px',
                    '--yt-delhi-pill-top-height': '8px',
                    '--yt-delhi-bottom-controls-height': '56px',
                    '--yt-delhi-bottom-controls-height-xsmall-width-mode': '56px',
                    '--yt-delhi-big-mode-pill-height': '48px',
                    '--yt-delhi-big-mode-pill-top-height': '12px',
                    '--yt-delhi-big-mode-bottom-controls-height': '72px'
                });

                // === 8. Force player reinit (so controls actually become compact) ===
                player.classList.add('efyt-reinit');
                void player.offsetHeight;
                player.classList.remove('efyt-reinit');

                // === 9. Body trigger class ===
                document.body.classList.add('efyt-mini-player');
            }

            // === 3. Main scroll handler ===
            function handleScroll() {
                const scrollY = window.scrollY || document.documentElement.scrollTop;

                Layout.updateLayout();

                // Scroll-to-top button
                const scrollTopContainer = document.getElementById('scroll-top-container');
                if (scrollTopContainer) {
                    scrollTopContainer.style.opacity = (scrollY > 1000 && utils.checkIfWatchPage()) ? '1' : '0';
                }
                if (utils.checkIfWatchPage() && !wsState.isScrollButtonCreated) {
                    createScrollToTopBtn();
                }

                // Smart mini-player activation
                const nowAbove1000 = scrollY > 1000;
                if (nowAbove1000 !== wasAbove1000) {
                    wasAbove1000 = nowAbove1000;
                    if (nowAbove1000) {
                        activateMiniPlayer();
                    } else {
                        resetMiniPlayerCompletely();
                    }
                }
            }
            function createMiniPlayer() {

                // Only add layout classes â€“ DO NOT activate yet
                document.body.classList.add('efyt-mini-player-top-right', 'efyt-mini-player-560x315');

                // Ensure clean state on fresh load
                resetMiniPlayerCompletely();

                // If page loaded already scrolled, activate immediately
                if (window.scrollY >= 1000) {
                    wasAbove1000 = true;
                    activateMiniPlayer();
                }
            }

            function destroyMiniPlayer() {
                resetMiniPlayerCompletely();
                document.body.classList.remove('efyt-mini-player-top-right', 'efyt-mini-player-560x315');
            }

            function createScrollToTopBtn() {
                let scrollTopContainer = document.getElementById('scroll-top-container');
                if (!scrollTopContainer) {
                    scrollTopContainer = document.createElement('div');
                    scrollTopContainer.setAttribute('id', 'scroll-top-container');
                    scrollTopContainer.className = 'navigation-button style-scope ytd-watch-flexy';
                    const scrollToTopBtn = document.createElement('button');
                    scrollToTopBtn.setAttribute('id', 'scroll-to-top');
                    scrollToTopBtn.className = 'scroll-top-btn';
                    scrollToTopBtn.setAttribute('aria-label', 'Scroll to Top');

                    const svgElement = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    const pathElement = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const divElement = document.createElement('div');

                    svgElement.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
                    svgElement.setAttribute('height', '24');
                    svgElement.setAttribute('viewBox', '0 0 24 24');
                    svgElement.setAttribute('width', '24');
                    svgElement.setAttribute('focusable', 'false');
                    svgElement.style.fill = 'red';
                    svgElement.style.display = 'flex';
                    pathElement.setAttribute('d', 'M19.884 10.114a1.25 1.25 0 01-1.768 1.768L13.25 7.016v12.982a1.25 1.25 0 11-2.5 0V7.016l-4.866 4.866a1.25 1.25 0 11-1.768-1.768L12 2.299l7.884 7.884Z');
                    svgElement.appendChild(pathElement);
                    divElement.classList.add('scroll-up-btn');
                    divElement.appendChild(svgElement);
                    scrollToTopBtn.appendChild(divElement);
                    scrollTopContainer.appendChild(scrollToTopBtn);
                    document.body.appendChild(scrollTopContainer);
                    wsState.isScrollButtonCreated = true;

                    const updatePosition = () => {
                        const viewportWidth = window.innerWidth;
                        let buttonPosition;
                        if ((window.screen.width >= 2560 && window.screen.width <= 3840) && (window.screen.height >= 1440 && window.screen.height <= 2160)) {
                            buttonPosition = 0.769 * (viewportWidth - 900) + 900;
                            buttonPosition = Math.max(900, Math.min(3160, buttonPosition));
                        } else {
                            buttonPosition = 0.904 * (viewportWidth - 1035) + 600;
                            buttonPosition = Math.max(600, Math.min(1800, buttonPosition));
                        }
                        scrollTopContainer.style.left = `${buttonPosition}px`;
                    };
                    updatePosition();

                    scrollToTopBtn.addEventListener('click', () => {
                        window.scrollTo({
                            top: 0,
                            behavior: 'smooth',
                        });
                        setTimeout(() => Layout.updateLayout(), 500);
                    });

                    window.addEventListener('resize', utils.throttle(() => {
                        if (utils.checkIfWatchPage()) {
                            updatePosition();
                        }
                    }, 30));
                }
            }

            function removeScrollButton() {
                const scrollTopContainer = document.getElementById('scroll-top-container');
                if (scrollTopContainer) {
                    scrollTopContainer.remove();
                    wsState.isScrollButtonCreated = false;
                }
            }

            return {
                createMiniPlayer,
                handleScroll,
                resetMiniPlayerCompletely,
                destroyMiniPlayer,
                createScrollToTopBtn,
                removeScrollButton
            };
        })();

        // MainPage Module: Placeholder for main page logic
        const MainPage = (function () {
            const { utils, cache } = Core;
            function updateGrid() {
                const selector = '#primary > ytd-rich-grid-renderer';
                utils.waitForDOMElement(selector, (gridRenderer) => {
                    gridRenderer.style.setProperty('--ytd-rich-grid-items-per-row', '4', '!important');
                }, {
                    interval: 200,
                    timeout: 20000,
                    delay: 500
                });
            }
            return { updateGrid };
        })();

        // Navigation Module: URL-based navigation and event handling
        const Navigation = (function () {
            const { state, utils, cache } = Core;

            function handleNavigationChange() {
                const currentUrl = window.location.href;
                const currentPath = window.location.pathname;
                if (currentUrl !== state.lastUrl) {
                    // Reset cache only if the base path changes (ignore ?v changes)
                    if (!state.lastUrl || currentPath !== new URL(state.lastUrl).pathname) {
                        cache.center = null;
                        cache.container = null;
                        cache.primary = null;
                        cache.columns = null;
                    }
                    state.lastUrl = currentUrl;
                    const currentShortsId = utils.getShortsId();
                    if (currentUrl.includes('youtube.com/shorts')) {
                        if (state.isScrollButtonCreated) {
                            Watch.removeScrollButton();
                        }
                        if (currentShortsId !== state.lastShortsId || currentShortsId !== state.observerShortsId || !state.observer) {
                            state.lastShortsId = currentShortsId;
                            if (state.observer && currentShortsId !== state.observerShortsId) {
                                state.observer.disconnect();
                                state.observer = null;
                                state.observerShortsId = null;
                            }
                            Shorts.SkippingShortsMechanism();
                        }
                        Shorts.createShortsSkipBtn();
                    } else if (utils.checkIfWatchPage()) {
                        Shorts.removeToggleButton();
                        if (state.observer) {
                            state.observer.disconnect();
                            state.observer = null;
                            state.observerShortsId = null;
                        }
                        state.lastShortsId = null;
                        state.lastProcessedShortsId = null;
                        if (!state.isScrollButtonCreated) {
                            Watch.createScrollToTopBtn();
                        }
                        if (!state.isMiniPlayerActive) {
                            Watch.createMiniPlayer();
                            state.isMiniPlayerActive = true;
                        }
                        Watch.resetMiniPlayerCompletely();
                    } else {
                        Shorts.removeToggleButton();
                        if (state.isScrollButtonCreated) {
                            Watch.removeScrollButton();
                        }
                        if (state.isMiniPlayerActive) {
                            Watch.destroyMiniPlayer();
                            state.isMiniPlayerActive = false;
                        }
                        if (state.observer) {
                            state.observer.disconnect();
                            state.observer = null;
                            state.observerShortsId = null;
                        }
                        state.lastShortsId = null;
                        state.lastProcessedShortsId = null;
                    }
                    Layout.updateLayout();
                }
            }

            return { handleNavigationChange };
        })();

        // Global Event Listeners and Initial Calls
        document.addEventListener('wheel', function (event) {
            if (!Core.utils.checkIfShortsPage()) return;
            const now = Date.now();
            if (event.deltaY !== 0 && now - Core.state.lastWheelEvent > Core.state.debounceDelay) {
                Core.state.lastWheelEvent = now;
                if (Core.utils.checkIfShortsPage()) {
                    const currentShortsId = Core.utils.getShortsId();
                    if (currentShortsId !== Core.state.observerShortsId) {
                        if (Core.state.observer) {
                            Core.state.observer.disconnect();
                            Core.state.observer = null;
                            Core.state.observerShortsId = null;
                        }
                        Core.state.lastShortsId = currentShortsId;
                    }
                }
            }
        });

        // Attach the same handler to both keydown and keyup events
        document.addEventListener('keydown', Shorts.handleKeyEvent);
        document.addEventListener('keyup', Shorts.handleKeyEvent);

        window.addEventListener('scroll', Core.utils.debounce(Watch.handleScroll, 150));
        window.addEventListener('resize', Core.utils.debounce(Watch.handleScroll, 150));

        window.addEventListener('resize', Core.utils.throttle(() => {
            Layout.updateLayout();
            if (Core.utils.checkIfWatchPage() && !Core.state.isScrollButtonCreated) {
                Watch.createScrollToTopBtn();
            }
        }, 30));

        window.addEventListener('popstate', () => {
            Layout.updateLayout();
            Navigation.handleNavigationChange();
        });
        MainPage.updateGrid();

        const titleObserver = new MutationObserver(Core.utils.debounce(() => {
            Navigation.handleNavigationChange();
        }, 80));
        titleObserver.observe(document.querySelector('title'), { childList: true });
    })();
