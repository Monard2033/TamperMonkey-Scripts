// ==UserScript==
// @name Youtube Enhancer
// @namespace http://tampermonkey.net/
// @version 2.1
// @description Optimizat pentru performanță - v2.1 cu eliminarea redundanțelor
// @author Michael
// @match https://www.youtube.com/*
// @icon https://www.google.com/s2/favicons?sz=64&domain=youtube.com
// @grant none
// ==/UserScript==

(function () {
    'use strict';

    // CONFIG - toate constantele centralizate
    const CONFIG = {
        masthead: {
            minCenter: 200,
            maxCenter: 550,
            breakpoint: 1035,
            growthFactor: 0.3955,
            opacityThreshold: 40
        },
        watch: {
            topBarHeightPx: 56,
            defaultMaxWidthPrimary: 1850,
            defaultMaxWidthColumns: 2065,
            uhd: {
                minWidth: 2560, minHeight: 1440,
                maxWidth: 3840, maxHeight: 2160,
                maxWidthPrimary: 3300,
                maxWidthColumns: 3600
            },
            heightChangeThreshold: 0.4
        },
        miniPlayer: {
            width: 560,
            height: 315,
            top: 55,
            positionFactorUHD: 0.769,
            positionFactorDefault: 0.8633,
            positionMinUHD: 2560,
            positionMaxUHD: 3840,
            positionMinDefault: 410,
            positionMaxDefault: 1300,
            scrollThreshold: 1000
        },
        timings: {
            scrollThrottle: 65,
            resizeDebounce: 120
        },
        selectors: {
            mastheadCenter: '#center.ytd-masthead',
            mastheadContainer: '#container.ytd-masthead',
            watchPrimary: '#primary',
            watchColumns: '#columns',
            shortsProgressBar: '#scrubber > desktop-shorts-player-controls > div > yt-progress-bar > div',
            shortsNavDown: '#navigation-button-down > ytd-button-renderer > yt-button-shape > button',
            gridRenderer: '#primary > ytd-rich-grid-renderer'
        }
    };

    // Core - state, utils, cache cu optimizări
    const Core = (function () {
        const state = {
            isSkippingEnabled: true,
            hasNavigationButtonBeenFetched: false,
            navigationButtonDown: null,
            lastShortsId: null,
            observer: null,
            observerShortsId: null,
            isScrollButtonCreated: false,
            lastProcessedShortsId: null,
            lastHeightVh: '90',
            lastScrollY: 0,
            lastWidth: window.innerWidth,
            isMiniPlayerActive: false,
            lastMiniLeft: 0,
            lastUrl: null,
            lastKeyEvent: 0,
            debounceDelay: 200,
            isClicked: false
        };

        const cache = new Map();
        const playerElementsCache = new Map();

        function throttle(fn, delay) {
            let last = 0;
            return (...args) => {
                const now = Date.now();
                if (now - last >= delay) {
                    last = now;
                    fn(...args);
                }
            };
        }

        function debounce(fn, delay) {
            let id;
            return (...args) => {
                clearTimeout(id);
                id = setTimeout(() => fn(...args), delay);
            };
        }

        function getElement(selector) {
            if (!cache.has(selector)) {
                const el = document.querySelector(selector);
                if (el) cache.set(selector, el);
                return el;
            }
            const cached = cache.get(selector);
            return cached && cached.isConnected ? cached : null;
        }

        function waitForElement(selector, options = {}) {
            const { timeout = 15000, interval = 100 } = options;
            return new Promise((resolve, reject) => {
                const el = getElement(selector);
                if (el) return resolve(el);
                const start = Date.now();
                const check = () => {
                    const el = getElement(selector);
                    if (el) resolve(el);
                    else if (Date.now() - start < timeout) setTimeout(check, interval);
                    else reject(new Error(`Timeout for ${selector}`));
                };
                check();
            });
        }

        function waitForAllDOMElements(selectors, options = {}) {
            const { timeout = 15000, maxRetries = 3 } = options;
            return Promise.all(selectors.map((selector, index) =>
                waitForElement(selector, { timeout }).then(element => ({
                    selector,
                    element,
                    index
                })).catch(error => {
                    if (maxRetries > 0) {
                        return waitForAllDOMElements([selector], { timeout, maxRetries: maxRetries - 1 });
                    }
                    throw error;
                })
            )).then(results => results.reduce((acc, r) => {
                acc[selectors[r.index]] = { element: r.element };
                return acc;
            }, {}));
        }

        function checkIfWatchPage() {
            return window.location.href.includes('youtube.com/watch');
        }

        function checkIfShortsPage() {
            return window.location.href.includes('youtube.com/shorts');
        }

        function getShortsId() {
            const match = window.location.href.match(/youtube\.com\/shorts\/([^?]+)/);
            return match ? match[1] : null;
        }

        function pauseVideo() {
            const video = document.querySelector('video');
            if (video && !video.paused) video.pause();
        }

        function safeInjectCSS(css, id) {
            let style = document.getElementById(id);
            if (!style) {
                style = document.createElement('style');
                style.id = id;
                document.head.appendChild(style);
            }
            style.textContent = css;
        }

        function clearPlayerCache() {
            playerElementsCache.clear();
        }

        return {
            state,
            cache,
            playerElementsCache,
            utils: {
                throttle,
                debounce,
                getElement,
                waitForElement,
                waitForAllDOMElements,
                checkIfWatchPage,
                checkIfShortsPage,
                getShortsId,
                pauseVideo,
                safeInjectCSS,
                clearPlayerCache
            }
        };
    })();

    // Styles - CSS base injectat o dată
    (function injectBaseStyles() {
        const styleElement = document.createElement('style');
        document.head.appendChild(styleElement);
        styleElement.textContent = `
            :root {
                --dark-bt: rgb(200 200 200 / 15%);
                --dark-bt-hover: rgba(255 255 255 /25%);
                --dark-bt-tp: rgb(0 0 0 / 1%);
                --light-bt: rgb(0 0 0 / 7%);
                --light-bt-tp: rgb(255 255 255 / 1%);
                --light-bt-hover: rgb(0 0 0 / 15%);
                --efyt-mini-player-aspect-ratio: 1.8;
                --efyt-mini-player-height: 315px;
                --efyt-mini-player-width: 560px;
                --efyt-mini-player-center-left: calc(100vw / 2 - 280px);
                --efyt-mini-player-caption-window-left: calc(var(--efyt-mini-player-width) * 1 / 10);
                --efyt-mini-player-caption-window-width: calc(var(--efyt-mini-player-width) * 8 / 10);
                --efyt-mini-player-short-width: calc(var(--efyt-mini-player-height) * var(--efyt-mini-player-aspect-ratio));
                --efyt-mini-player-short-left: calc(calc(var(--efyt-mini-player-width) - calc(var(--efyt-mini-player-height) * var(--efyt-mini-player-aspect-ratio))) / 2);
                --efyt-mini-width: 560px;
                --efyt-mini-height: 315px;
                --efyt-mini-top: 55px;
                --efyt-mini-left: 410px;
                --efyt-mini-radius: 14px;
            }
            #start.ytd-masthead, #end.ytd-masthead {
                height: 50px;
                border-radius: 30px;
                display: flex;
                position: static;
                margin: 0 10%;
                border: 1px dotted red;
                background-color: var(--light-bt);
            }
            .ytSearchboxComponentHost {
                height: 53px;
                margin: 0 12px 0 0;
            }
            .ytSearchboxComponentInputBox {
                margin: 0 0 0 0;
                border: 1px dotted red;
                box-shadow: none;
                height: 50px;
                background: transparent;
                background-color: var(--light-bt);
                display: flex;
                justify-content: space-around;
            }
            #center.ytd-masthead {
                margin: auto;
                flex: 0 0 550px;
            }
            .ytp-delhi-modern.ytp-big-mode:not(.ytp-xsmall-width-mode) .ytp-chrome-bottom {
                height: 80px !important;
            }
            .ytp-big-mode .ytp-progress-bar-container {
                bottom: 65.5px !important;
            }
            ytd-rich-grid-renderer {
                --ytd-rich-grid-items-per-row: 4 !important;
            }
            #container.ytd-masthead {
                box-shadow: none;
                background: transparent;
                display: flex;
                opacity: 1;
                z-index: 1000;
                justify-content: space-evenly;
            }
            #contents.ytd-rich-grid-renderer {
                padding-top: 65px;
            }
            ytd-watch-flexy[flexy] #secondary.ytd-watch-flexy {
                min-width: 450px;
                padding-right: 0px;
            }
            .ytSearchboxComponentSearchButton {
                background: transparent;
                border: 1px dotted red;
                background-color: var(--light-bt) !important;
                height: 52px;
            }
            #background.ytd-masthead {
                position: fixed;
                opacity: 0;
                visibility: visible;
                background: transparent;
                height: 56px;
                z-index -1;
            }
            #search-form.ytd-searchbox {
                height: 50px;
            }
            ytd-searchbox.ytd-masthead {
                margin: 0;
                padding: 0 10px;
            }
            #sections.ytd-guide-renderer {
                position: relative;
            }
            #sections.ytd-guide-renderer>*.ytd-guide-renderer:first-child {
                padding: 0px;
            }
            #voice-search-button.ytd-masthead {
                margin-left: 0;
                background: transparent;
                background-color: var(--light-bt) !important;
            }
            #chips-wrapper.ytd-feed-filter-chip-bar-renderer {
                opacity: 0.6;
            }
            .ytSpecIconShapeHost {
                color: #c00;
            }
            ytd-feed-filter-chip-bar-renderer {
                height: 0;
            }
            #frosted-glass.with-chipbar.ytd-app {
                height: 112px !important;
                backdrop-filter: blur(2px) !important;
            }
            .yt-core-attributed-string--white-space-no-wrap {
                color: #c00;
            }
            .yt-spec-button-shape-next--mono.yt-spec-button-shape-next--filled {
                background: none;
                color: black;
            }
            yt-chip-cloud-chip-renderer[chip-style=STYLE_DEFAULT][selected] #chip-container.yt-chip-cloud-chip-renderer {
                background-color: var(--yt-spec-badge-chip-background);
                color: var(--yt-spec-text-primary);
            }
            .yt-spec-touch-feedback-shape:where([class="yt-spec-touch-feedback-shape yt-spec-touch-feedback-shape--touch-response"]) {
                border: 1px dotted red;
            }
            body.efyt-mini-player.efyt-short #movie_player:not(.ytp-fullscreen) video.html5-main-video,
            body.efyt-wide-player.efyt-mini-player.efyt-short ytd-watch-flexy[theater] #movie_player:not(.ytp-fullscreen) video.html5-main-video {
                left: var(--efyt-mini-player-short-left);
                aspect-ratio: auto;
                object-fit: contain;
            }
            body.efyt-mini-player #movie_player:not(.ytp-fullscreen) .ytp-caption-window-container > div.caption-window {
                left: var(--efyt-mini-player-caption-window-left);
            }
            body.efyt-mini-player.efyt-short #movie_player:not(.ytp-fullscreen) {
                height: var(--efyt-mini-player-height);
                aspect-ratio: auto;
            }
            body.efyt-mini-player ytd-player #movie_player:not(.ytp-fullscreen) {
                position: fixed !important;
                z-index: 5000 !important;
                background: rgb(0, 0, 0) !important;
            }
            .efyt-mini-active #movie_player {
                position: fixed !important;
                z-index: 5000 !important;
                width: var(--efyt-mini-width) !important;
                height: var(--efyt-mini-height) !important;
                top: var(--efyt-mini-top) !important;
                left: var(--efyt-mini-left) !important;
                border-radius: var(--efyt-mini-radius) !important;
                background: rgb(0, 0, 0) !important;
            }
            .efyt-mini-active .html5-main-video {
                width: var(--efyt-mini-width) !important;
                height: var(--efyt-mini-height) !important;
                left: 0 !important;
                border-radius: var(--efyt-mini-radius) !important;
                object-fit: contain !important;
            }
            .efyt-mini-active .ytp-chrome-bottom {
                left: 10px !important;
                width: calc(100% - 20px) !important;
                max-width: 530px !important;
            }
            @media (prefers-color-scheme: dark) {
                #start.ytd-masthead,
                .ytSearchboxComponentInputBox,
                #container.ytd-searchbox,
                #end.ytd-masthead,
                .scroll-top-btn,
                .skip-toggle-btn,
                .ytSearchboxComponentSearchButton,
                .yt-spec-touch-feedback-shape:where([class="yt-spec-touch-feedback-shape yt-spec-touch-feedback-shape--touch-response"]),
                #voice-search-button.ytd-masthead {
                    background-color: var(--dark-bt) !important;
                }
                #content > yt-lockup-view-model > div > yt-touch-feedback-shape > div {
                    background-color: var(--dark-bt-tp);
                }
                .yt-spec-button-shape-next--mono.yt-spec-button-shape-next--filled {
                    color: red;
                }
                #start.ytd-masthead:hover,
                .ytSearchboxComponentInputBox:hover,
                #container.ytd-searchbox:hover,
                #end.ytd-masthead:hover,
                .scroll-top-btn:hover,
                .skip-toggle-btn:hover,
                .ytSearchboxComponentSearchButton:hover,
                .yt-spec-button-shape-next--overlay.yt-spec-button-shape-next--text:hover,
                #voice-search-button.ytd-masthead:hover {
                    background-color: var(--dark-bt-hover) !important;
                }
            }
            #scroll-top-container {
                position: fixed;
                bottom: 20px;
                width: 55px;
                height: 55px;
                transition: opacity 0.3s ease;
                z-index: 1000;
                opacity: 0;
            }
            .scroll-top-btn {
                pointer-events: all;
                width: 100%;
                height: 100%;
                border-radius: 50%;
                cursor: pointer;
                border: 1px dotted red;
                display: flex;
                justify-content: center;
                align-items: center;
                background-color: var(--light-bt);
            }
            .scroll-top-btn:hover {
                background-color: var(--light-bt-hover);
            }
            .scroll-up-btn {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100%;
                width: 100%;
            }
            .skip-toggle-btn {
                pointer-events: all;
                width: 56px;
                height: 56px;
                margin: 0;
                border-radius: 50%;
                cursor: pointer;
                border: none;
                transition: background-color 0.2s ease, opacity 4s ease;
                opacity: 1;
                justify-self: center;
                align-items: center;
            }
            .skip-toggle-btn:hover {
                background-color: var(--light-bt-hover) !important;
            }
            .toggle-icon {
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100%;
                width: 100%;
                color: #c00;
                font-size: 13px;
                font-family: 'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande',
                'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
                font-weight: 600;
            }
            .skip-tooltip {
                display: flex;
                position: absolute;
                left: -150px;
                top: 0;
                height: 25px;
                transform: translateY(8px);
                background-color: #707070;
                color: #ffffff;
                padding: 6px 8px;
                border-radius: 4px;
                font-family: "Roboto", "Arial", sans-serif;
                font-size: 1.2rem;
                line-height: 1.8rem;
                font-weight: 400;
                align-items: center;
                z-index: 1001;
                opacity: 0;
                visibility: hidden;
                transition: opacity 0.2s ease-in-out;
            }
            .skip-toggle-btn:hover+.skip-tooltip,
            .skip-tooltip:hover {
                opacity: 1;
                visibility: visible;
            }
        `;
    })();

    // Layout - optimizat fără redundanțe
    const Layout = (function () {
        const { utils, state } = Core;
        let mastheadCacheInitialized = false;

        function calculateFlexBasis(w) {
            let basis = CONFIG.masthead.minCenter + (w - CONFIG.masthead.breakpoint) * CONFIG.masthead.growthFactor;
            return Math.max(CONFIG.masthead.minCenter, Math.min(CONFIG.masthead.maxCenter, basis));
        }

        function initMastheadCache() {
            if (mastheadCacheInitialized) return;
            mastheadCacheInitialized = true;
            utils.waitForElement(CONFIG.selectors.mastheadCenter).catch(() => {});
            utils.waitForElement(CONFIG.selectors.mastheadContainer).catch(() => {});
        }

        function updateMasthead(scrollY = 0) {
            const center = utils.getElement(CONFIG.selectors.mastheadCenter);
            const container = utils.getElement(CONFIG.selectors.mastheadContainer);
            if (!center || !container) return;

            const newOpacity = scrollY < CONFIG.masthead.opacityThreshold ? '1' : '0.6';
            if (container.style.opacity !== newOpacity) {
                container.style.opacity = newOpacity;
            }

            const w = window.innerWidth;
            center.style.flex = `0 0 ${calculateFlexBasis(w)}px`;
        }

        function calculateWatchHeight() {
            const vh = window.innerHeight;
            const topVh = (CONFIG.watch.topBarHeightPx / vh) * 100;
            const availVh = 100 - topVh;
            const aspectVh = (window.innerWidth / vh) * (9 / 16) * 100;
            return Math.min(availVh, aspectVh).toFixed(2);
        }

        function getWatchMaxWidths() {
            let primW = CONFIG.watch.defaultMaxWidthPrimary;
            let colW = CONFIG.watch.defaultMaxWidthColumns;
            const sw = window.screen.width, sh = window.screen.height;
            if (sw >= CONFIG.watch.uhd.minWidth && sw <= CONFIG.watch.uhd.maxWidth &&
                sh >= CONFIG.watch.uhd.minHeight && sh <= CONFIG.watch.uhd.maxHeight) {
                primW = CONFIG.watch.uhd.maxWidthPrimary;
                colW = CONFIG.watch.uhd.maxWidthColumns;
            }
            return { primW, colW };
        }

        function updateWatchStyles() {
            if (!utils.checkIfWatchPage()) return;

            const newHeight = calculateWatchHeight();
            if (Math.abs(parseFloat(newHeight) - parseFloat(state.lastHeightVh)) <= CONFIG.watch.heightChangeThreshold) return;
            state.lastHeightVh = newHeight;

            const { primW, colW } = getWatchMaxWidths();

            const css = `
                #primary.ytd-watch-flexy {
                    max-width: ${primW}px !important;
                    margin-left: 10px !important;
                    margin-top: 12px !important;
                }
                #columns.ytd-watch-flexy {
                    max-width: ${colW}px !important;
                }
                ytd-watch-flexy[full-bleed-player][respect-aspect-ratio]:not([fullscreen]) #full-bleed-container.ytd-watch-flexy,
                ytd-watch-flexy[full-bleed-player] #full-bleed-container.ytd-watch-flexy {
                    z-index: 1200 !important;
                    height: ${newHeight}vh !important;
                    max-height: ${newHeight}vh !important;
                }
                .html5-video-player .video-stream {
                    top: 2px !important;
                    height: ${newHeight}vh;
                    max-height: ${newHeight}vh !important;
                }
                .ytp-fit-cover-video .html5-main-video {
                    object-fit: contain !important;
                }
                .ytp-delhi-modern .ytp-heat-map-container {
                    left: 5px !important;
                }
                .ytp-progress-bar {
                    left: 5px !important;
                }
                ytd-watch-flexy[full-bleed-player] #player-container.ytd-watch-flexy,
                ytd-watch-flexy[full-bleed-player] #player.ytd-watch-flexy {
                    max-height: ${newHeight}vh !important;
                    height: ${newHeight}vh !important;
                }
            `;
            utils.safeInjectCSS(css, 'efyt-watch-styles');
        }

        return { initMastheadCache, updateMasthead, updateWatchStyles };
    })();

    // Shorts - optimizat cu observer unic
    const Shorts = (function () {
        const { state, utils } = Core;

        function createShortsSkipBtn() {
            if (utils.checkIfShortsPage()) {
                let autoskipContainer = document.getElementById('shorts-autoskip');
                if (!autoskipContainer) {
                    autoskipContainer = document.createElement('div');
                    autoskipContainer.className = 'navigation-button style-scope ytd-shorts';
                    autoskipContainer.id = 'shorts-autoskip';

                    const toggleButton = document.createElement('button');
                    toggleButton.id = 'shorts-skip-toggle';
                    toggleButton.className = 'skip-toggle-btn';

                    const touchFeedbackShape = document.createElement('div');
                    touchFeedbackShape.className = 'yt-spec-touch-feedback-shape yt-spec-touch-feedback-shape--touch-response';
                    toggleButton.appendChild(touchFeedbackShape);

                    const icon = document.createElement('span');
                    icon.className = 'toggle-icon';
                    icon.textContent = 'SKIP';
                    toggleButton.appendChild(icon);

                    const tooltip = document.createElement('div');
                    tooltip.className = 'skip-tooltip';
                    tooltip.textContent = 'Toggle Video Skipping';
                    tooltip.setAttribute('role', 'tooltip');
                    tooltip.setAttribute('aria-label', 'Toggle Video Skipping');

                    autoskipContainer.appendChild(toggleButton);
                    autoskipContainer.appendChild(tooltip);

                    utils.waitForElement('.navigation-container.style-scope.ytd-shorts')
                        .then(navigationContainer => {
                            utils.waitForElement('#navigation-button-up')
                                .then(navigationButtonUp => {
                                    navigationContainer.insertBefore(autoskipContainer, navigationButtonUp);
                                })
                                .catch(() => {});
                        })
                        .catch(() => {});

                    toggleButton.addEventListener('click', () => {
                        state.isSkippingEnabled = !state.isSkippingEnabled;
                        icon.textContent = state.isSkippingEnabled ? 'SKIP' : 'NO SKIP';

                        if (state.isSkippingEnabled && state.observer) {
                            const progressBarElement = document.querySelector(CONFIG.selectors.shortsProgressBar);
                            if (progressBarElement) {
                                state.observer.observe(progressBarElement, {
                                    attributes: true,
                                    attributeFilter: ['aria-valuetext'],
                                });
                            }
                        } else if (!state.isSkippingEnabled && state.observer) {
                            state.observer.disconnect();
                        }
                    });
                }
            }
        }

        function initProgressBarObserver(progressBarElement, navButton) {
            if (state.observer) {
                state.observer.disconnect();
            }

            let maxWidth = 0;
            let previousWidth = 0;
            const currentShortsId = utils.getShortsId();

            state.observer = new MutationObserver(mutations => {
                if (!state.isSkippingEnabled) return;

                mutations.forEach(mutation => {
                    if (mutation.attributeName === 'aria-valuetext') {
                        let currentProgressBar = document.querySelector(CONFIG.selectors.shortsProgressBar);
                        if (!currentProgressBar || currentProgressBar !== progressBarElement) {
                            if (state.observer) {
                                state.observer.disconnect();
                                state.observer = null;
                            }
                            return;
                        }

                        let ariaValueText = progressBarElement.getAttribute('aria-valuetext');
                        if (ariaValueText) {
                            let widthNumber = parseFloat(ariaValueText.replace('%', ''));
                            if (widthNumber >= maxWidth) {
                                maxWidth = widthNumber;
                                previousWidth = widthNumber;
                            } else if (!state.isClicked) {
                                if ((widthNumber === 0 || widthNumber === 1) && previousWidth >= 97) {
                                    utils.pauseVideo();
                                    if (state.navigationButtonDown) {
                                        state.navigationButtonDown.click();
                                    }
                                    state.isClicked = true;
                                    if (state.observer) {
                                        state.observer.disconnect();
                                        state.observer = null;
                                    }
                                    maxWidth = 0;
                                    previousWidth = 0;
                                } else {
                                    previousWidth = widthNumber;
                                }
                            }
                        }
                    }
                });
            });

            if (state.isSkippingEnabled) {
                state.observer.observe(progressBarElement, {
                    attributes: true,
                    attributeFilter: ['aria-valuetext'],
                });
            }
            state.observerShortsId = currentShortsId;
        }

        function initializeShortsObserver() {
            const currentShortsId = utils.getShortsId();

            if (currentShortsId === state.observerShortsId && state.observer) {
                return;
            }

            state.lastProcessedShortsId = currentShortsId;

            const selectors = [
                CONFIG.selectors.shortsNavDown,
                CONFIG.selectors.shortsProgressBar
            ];

            utils.waitForAllDOMElements(selectors, { timeout: 10000, maxRetries: 2 })
                .then(results => {
                    const navButton = results[selectors[0]].element;
                    const progressBarElement = results[selectors[1]].element;

                    if (!state.hasNavigationButtonBeenFetched) {
                        state.navigationButtonDown = navButton;
                        state.hasNavigationButtonBeenFetched = true;
                    }

                    initProgressBarObserver(progressBarElement, navButton);
                })
                .catch(err => console.error(`Failed to initialize Shorts observer: ${err.message}`));
        }

        function handleKeyEvent(event) {
            if (!utils.checkIfShortsPage()) return;
            const now = Date.now();
            if ((event.keyCode === 38 || event.keyCode === 40) && now - state.lastKeyEvent > state.debounceDelay) {
                state.lastKeyEvent = now;
                const currentShortsId = utils.getShortsId();
                if (currentShortsId !== state.observerShortsId) {
                    initializeShortsObserver();
                }
            }
        }

        function removeToggleButton() {
            const toggleButton = document.querySelector('#shorts-skip-toggle');
            if (toggleButton && toggleButton.parentNode) {
                toggleButton.dispatchEvent(new Event('remove'));
                toggleButton.parentNode.removeChild(toggleButton);
            }
        }

        function cleanup() {
            if (state.observer) {
                state.observer.disconnect();
                state.observer = null;
            }
        }

        return { createShortsSkipBtn, initializeShortsObserver, handleKeyEvent, removeToggleButton, cleanup };
    })();

    // Watch - optimizat cu caching agresiv
    const Watch = (function () {
        const { state, utils, playerElementsCache } = Core;
        let miniPlayerInitialized = false;
        let wasAbove1000 = false;
        let scrubberEnforceObserver = null;
        const originalStyles = new Map();

        function calculatePosition(w) {
            let position;
            if ((window.screen.width >= CONFIG.miniPlayer.positionMinUHD && window.screen.width <= CONFIG.miniPlayer.positionMaxUHD) &&
                (window.screen.height >= CONFIG.miniPlayer.positionMinUHD && window.screen.height <= CONFIG.miniPlayer.positionMaxUHD)) {
                    console.log('UHD detected for mini player positioning');
                position = Math.max(CONFIG.miniPlayer.positionMinUHD, Math.min(CONFIG.miniPlayer.positionMaxUHD, CONFIG.miniPlayer.positionFactorUHD * (w - 900) + 900));
            } else {
                console.log('Default settings for mini player positioning');
                position = Math.max(CONFIG.miniPlayer.positionMinDefault, Math.min(CONFIG.miniPlayer.positionMaxDefault, CONFIG.miniPlayer.positionFactorDefault * (w - 985) + 100));
            }
            return position;
        }

        function stopScrubberEnforcer() {
            if (scrubberEnforceObserver) {
                scrubberEnforceObserver.disconnect();
                scrubberEnforceObserver = null;
            }
        }

        function resetMiniPlayer() {
            stopScrubberEnforcer();
            const player = document.querySelector("#player");
            const moviePlayer = document.querySelector("#movie_player");
            const video = document.querySelector("video.html5-main-video");
            const chromeBottom = document.querySelector(".ytp-chrome-bottom");
            const progressContainer = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-heat-map-container");
            const progressBar = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-progress-bar");
            const chapterContainer = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-progress-bar > div.ytp-chapters-container > div");
            const scrubber = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-progress-bar > div.ytp-scrubber-container");
            const buttonsvg = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-chrome-controls > div.ytp-left-controls > button > svg");
           
            if (player) {
                player.classList.remove(
                    'ytp-delhi-modern-compact-controls',
                    'ytp-rounded-miniplayer-not-regular-wide-video',
                    'playing-mode'
                );
            }

            // Restore original styles instead of clearing them
            const elementsToRestore = [
                { el: video, id: 'video' },
                { el: moviePlayer, id: 'moviePlayer' },
                { el: chromeBottom, id: 'chromeBottom' },
                { el: progressContainer, id: 'progressContainer' },
                { el: progressBar, id: 'progressBar' },
                { el: scrubber, id: 'scrubber' },
                { el: buttonsvg, id: 'buttonsvg' },
                { el: chapterContainer, id: 'chapterContainer' }
            ];

            elementsToRestore.forEach(({ el, id }) => {
                if (el && originalStyles.has(id)) {
                    el.style.cssText = originalStyles.get(id);
                }
            });

            // Also remove custom CSS properties from player
            if (player) {
                const storedPlayerStyles = originalStyles.get('player');
                if (storedPlayerStyles) {
                    player.style.cssText = storedPlayerStyles;
                }
            }

            // Remove custom property from document root
            document.documentElement.style.removeProperty('--efyt-mini-left');

            document.body.classList.remove('efyt-mini-player');
            document.body.classList.remove('efyt-mini-active');
            wasAbove1000 = false;
        }

        function activateMiniPlayer() {
            const viewportWidth = window.innerWidth;
            const position = calculatePosition(viewportWidth);
            const player = document.querySelector("#player");
            const moviePlayer = document.querySelector("#movie_player");
            const video = document.querySelector("video.html5-main-video");
            const chromeBottom = document.querySelector(".ytp-chrome-bottom");
            const progressContainer = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-heat-map-container");
            const progressBar = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-progress-bar");
            const chapterContainer = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-progress-bar > div.ytp-chapters-container > div");
            const scrubber = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-progress-bar-container > div.ytp-progress-bar > div.ytp-scrubber-container");
            const buttonsvg = document.querySelector("#movie_player > div.ytp-chrome-bottom > div.ytp-chrome-controls > div.ytp-left-controls > button > svg");

            // Store original styles before modifying (only once per activation)
            if (!originalStyles.has('player') && player) {
                originalStyles.set('player', player.getAttribute('style') || '');
            }
            if (!originalStyles.has('moviePlayer') && moviePlayer) {
                originalStyles.set('moviePlayer', moviePlayer.getAttribute('style') || '');
            }
            if (!originalStyles.has('video') && video) {
                originalStyles.set('video', video.getAttribute('style') || '');
            }
            if (!originalStyles.has('chromeBottom') && chromeBottom) {
                originalStyles.set('chromeBottom', chromeBottom.getAttribute('style') || '');
            }
            if (!originalStyles.has('progressContainer') && progressContainer) {
                originalStyles.set('progressContainer', progressContainer.getAttribute('style') || '');
            }
            if (!originalStyles.has('progressBar') && progressBar) {
                originalStyles.set('progressBar', progressBar.getAttribute('style') || '');
            }
            if (!originalStyles.has('scrubber') && scrubber) {
                originalStyles.set('scrubber', scrubber.getAttribute('style') || '');
            }
            if (!originalStyles.has('buttonsvg') && buttonsvg) {
                originalStyles.set('buttonsvg', buttonsvg.getAttribute('style') || '');
            }
            if (!originalStyles.has('chapterContainer') && chapterContainer) {
                originalStyles.set('chapterContainer', chapterContainer.getAttribute('style') || '');
            }

            document.documentElement.style.setProperty('--efyt-mini-left', `${position}px`);

            if(player) {
                Object.assign(player.style, {
                    '--yt-delhi-pill-height': '40px',
                    '--yt-delhi-pill-top-height': '8px',
                    '--yt-delhi-bottom-controls-height': '56px',
                    '--yt-delhi-bottom-controls-height-xsmall-width-mode': '56px',
                    '--yt-delhi-big-mode-pill-height': '48px',
                    '--yt-delhi-big-mode-pill-top-height': '12px',
                    '--yt-delhi-big-mode-bottom-controls-height': '72px'
                });
            }

            if (moviePlayer) {
                Object.assign(moviePlayer.style, {
                    width: `${CONFIG.miniPlayer.width}px`,
                    height: `${CONFIG.miniPlayer.height}px`,
                    left: `${position}px`,
                    top: `${CONFIG.miniPlayer.top}px`,
                    borderRadius: "15px",
                });
            }

            if (video) {
                Object.assign(video.style, {
                    width: `${CONFIG.miniPlayer.width}px`,
                    height: `${CONFIG.miniPlayer.height}px`,
                    left: "0px",
                    borderRadius: "15px",
                });
            }

            if (chromeBottom) {
                Object.assign(chromeBottom.style, {
                    left: "10px",
                    width: "98%",
                    maxWidth: `${CONFIG.miniPlayer.width - 30}px`,
                });
            }

            if (progressBar) {
                Object.assign(progressBar.style, {
                    width: `${CONFIG.miniPlayer.width - 30}px !important`,
                });
            }

            if (progressContainer) {
                Object.assign(progressContainer.style, {
                    zIndex: "60",
                    bottom: "0",
                    height: "60px",
                });
            }

            if (chapterContainer) {
                Object.assign(chapterContainer.style, {
                    width: "99%",
                });
            }

            if (scrubber && progressBar) {
                // Set up observer for scrubber position enforcement
                if (scrubberEnforceObserver) {
                    scrubberEnforceObserver.disconnect();
                }
                scrubberEnforceObserver = new MutationObserver(() => {
                    const cur = Number(progressBar.getAttribute("aria-valuenow") || 0);
                    const tot = Number(progressBar.getAttribute("aria-valuemax") || 100);
                    const computedW = progressBar.getBoundingClientRect().width;
                    const xPos = (cur / tot) * computedW;
                    scrubber.style.cssText = `transform: translateX(${xPos}px) !important;`;
                });
                scrubberEnforceObserver.observe(progressBar, {
                    attributes: true,
                    attributeFilter: ['aria-valuenow', 'aria-valuemax'],
                    subtree: false
                });
            }

            if (buttonsvg) {
                Object.assign(buttonsvg.style, {
                    padding: "12px !important",
                });
            }

            player.classList.add('efyt-reinit');
            void player.offsetHeight;
            player.classList.remove('efyt-reinit');

            player.classList.add(
                'ytp-delhi-modern-compact-controls',
                'ytp-rounded-miniplayer-not-regular-wide-video',
                'playing-mode'
            );
            document.body.classList.add('efyt-mini-player');
            document.body.classList.add('efyt-mini-active');
        }

        function handleScroll(scrollY) {
            const scrollContainer = document.getElementById('scroll-top-container');
            if (scrollContainer) {
                const newOpacity = (scrollY > CONFIG.miniPlayer.scrollThreshold && utils.checkIfWatchPage()) ? '1' : '0';
                if (scrollContainer.style.opacity !== newOpacity) {
                    scrollContainer.style.opacity = newOpacity;
                }
            }

            const currentScroll = scrollY > CONFIG.miniPlayer.scrollThreshold;
            if (currentScroll !== wasAbove1000) {
                wasAbove1000 = currentScroll;
                if (currentScroll) {
                    activateMiniPlayer();
                    state.isMiniPlayerActive = true;
                } else {
                    resetMiniPlayer();
                    state.isMiniPlayerActive = false;
                }
            }
        }

        function createScrollToTopBtn() {
            let scrollTopContainer = document.getElementById('scroll-top-container');
            if (!scrollTopContainer) {
                const buttonPosition = calculatePosition(window.innerWidth) + CONFIG.miniPlayer.width - 50;
                scrollTopContainer = document.createElement('div');
                scrollTopContainer.id = 'scroll-top-container';
                scrollTopContainer.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    width: 55px;
                    height: 55px;
                    z-index: 1000;
                    opacity: 0;
                    transition: opacity 0.3s ease;
                `;
                scrollTopContainer.style.left = `${buttonPosition}px`;


                const button = document.createElement('button');
                button.className = 'scroll-top-btn';
                const scrollUpDiv = document.createElement('div');
                scrollUpDiv.className = 'scroll-up-btn';
                scrollUpDiv.style.color = 'red';
                scrollUpDiv.textContent = '↑';
                scrollUpDiv.style.fontSize = '20px';
                button.appendChild(scrollUpDiv);
                button.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });

                scrollTopContainer.appendChild(button);
                document.body.appendChild(scrollTopContainer);
                state.isScrollButtonCreated = true;
            }
        }

        function removeScrollButton() {
            const scrollTopContainer = document.getElementById('scroll-top-container');
            if (scrollTopContainer) {
                scrollTopContainer.remove();
                state.isScrollButtonCreated = false;
            }
        }

        function cleanup() {
            stopScrubberEnforcer();
            resetMiniPlayer();
            playerElementsCache.clear();
            originalStyles.clear();
            miniPlayerInitialized = false;
        }

        return { handleScroll, createScrollToTopBtn, removeScrollButton, cleanup, calculatePosition };
    })();

    // MainPage - observer pe grid
    const MainPage = (function () {
        const { utils } = Core;
        let gridObserverInitialized = false;

        function updateGrid() {
            utils.waitForElement(CONFIG.selectors.gridRenderer).then(grid => {
                grid.style.setProperty('--ytd-rich-grid-items-per-row', '4', '!important');
            }).catch(() => {});
        }

        function initGridObserver() {
            if (gridObserverInitialized) return;
            gridObserverInitialized = true;

            utils.waitForElement('ytd-rich-grid-renderer').then(grid => {
                const gridObserver = new MutationObserver(Core.utils.debounce(() => {
                    updateGrid();
                }, 500));
                gridObserver.observe(grid, {
                    attributes: true,
                    subtree: true
                });
            }).catch(() => {});
        }

        return { updateGrid, initGridObserver };
    })();

    // Navigation - selective cache clear
    const Navigation = (function () {
        const { state, cache, utils } = Core;

        function handleChange() {
            const url = window.location.href;
            if (url === state.lastUrl) return;
            state.lastUrl = url;

            const relevantSelectors = [CONFIG.selectors.mastheadCenter, CONFIG.selectors.mastheadContainer];
            relevantSelectors.forEach(selector => cache.delete(selector));

            if (utils.checkIfShortsPage()) {
                Shorts.createShortsSkipBtn();
                Shorts.initializeShortsObserver();
                Watch.cleanup();
            } else if (utils.checkIfWatchPage()) {
                Watch.createScrollToTopBtn();
                Layout.updateWatchStyles();
                Layout.initMastheadCache();
                MainPage.initGridObserver();
                Shorts.cleanup();
            } else {
                Watch.cleanup();
                Shorts.cleanup();
            }

            Layout.updateMasthead(window.scrollY);
        }

        return { handleChange };
    })();

    // Global Events
    const throttledScroll = Core.utils.throttle((e) => {
        const scrollY = window.scrollY;
        if (Math.abs(scrollY - Core.state.lastScrollY) < 10) return;
        Core.state.lastScrollY = scrollY;

        Layout.updateMasthead(scrollY);

        if (Core.utils.checkIfWatchPage()) {
            Watch.handleScroll(scrollY);
        }
    }, CONFIG.timings.scrollThrottle);

    const debouncedResize = Core.utils.debounce(() => {
        const w = window.innerWidth;
        if (Math.abs(w - Core.state.lastWidth) < 10) return;
        Core.state.lastWidth = w;

        Layout.updateMasthead(Core.state.lastScrollY);
        Layout.updateWatchStyles();

        if (Core.utils.checkIfWatchPage()) {
            const newLeft = Watch.calculateMiniPlayerPosition(w);
            if (Math.abs(newLeft - Core.state.lastMiniLeft) > 5) {
                Core.state.lastMiniLeft = newLeft;
            }
        }
    }, CONFIG.timings.resizeDebounce);

    window.addEventListener('scroll', throttledScroll);
    window.addEventListener('resize', debouncedResize);
    window.addEventListener('popstate', Navigation.handleChange);
    document.addEventListener('keydown', (e) => Shorts.handleKeyEvent(e));

    // Init
    Layout.initMastheadCache();
    MainPage.updateGrid();
    Navigation.handleChange();

    const titleObserver = new MutationObserver(Core.utils.debounce(Navigation.handleChange, 100));
    const titleElement = document.querySelector('title');
    if (titleElement) {
        titleObserver.observe(titleElement, { childList: true });
    }
})();
